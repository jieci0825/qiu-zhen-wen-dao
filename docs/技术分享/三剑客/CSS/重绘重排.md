---
title: 重绘重排
---

# 重绘重排

## 概述 - 重绘、重排是什么

**重绘（Repaint）和重排（Reflow，也称回流）** 是浏览器渲染过程中两个关键的步骤，会直接影响页面性能。

当页面布局发生改变时，比如改变元素的宽高、位置等这种影响布局树的操作就会触发重排，例如 `dom.style.width = '100px'`。

同时浏览器也会进行优化处理，比如多次修改导致布局树发生反复计算，浏览器就会合并这些操作，当 js 代码全部完成后再进行统一计算。所以，**改动属性造成的 reflow 是异步的**。还有，当访问某些关于布局相关的属性时，如 offsetTop、clientWidth 等，则会触发**强制同步重排**，因为浏览器需要获取最新的布局信息。

而当元素的外观发生变化，比如元素的颜色、背景样式等发生改变时就只会触发重绘。

而一般常见的优化方法就是使用 CSS3 的 transform 和 opacity 来避免重排，因为它们可以利用GPU加速，或者将多个 DOM 操作合并，比如使用DocumentFragment。此外，将频繁操作的元素设置为 display: none，处理完再显示，也可以减少重排次数。

## 详解
### 重排（reflow）
- **定义**：当元素的**布局属性**（如尺寸、位置、内容变化）发生改变时，浏览器需要重新计算元素的几何属性，并调整其他元素的布局。

- **触发条件**：
    - 修改元素的尺寸（宽、高）、外边距（margin）、内边距（padding）。
    - 调整窗口的大小或设备方向（如旋转屏幕）
    - 添加/删除可见的 DOM 元素。
    - 读取某些属性（如 offsetTop、clientWidth），浏览器会强制同步重排已返回最新值

- **性能影响**：重排会导致整个渲染树重新计算，成本较高。

### 重绘（repaint）
- **定义**：当元素**外观属性**（如背景、颜色、边框）发生变化，但不影响布局时，浏览器仅重新绘制受影响区域。

- **触发条件**：
    - 修改颜色（clolr）、背景（background）、阴影（box-shadow）等样式。
    - 不影响布局的透明度（opacity）变化。

- **性能影响**：比重排轻量，但仍需避免高频触发（如动画）。

### 区别

|          | 重排（reflow）           | 重绘（repaint）          |
| -------- | ------------------------ | ------------------------ |
| **触发** | 布局变化（如尺寸、位置） | 外观变化（如颜色、背景） |
| **范围** | 可能影响整个布局树       | 仅影响当前元素或局部区域 |
| **成本** | 高（需重新计算布局）     | 低（仅重新绘制像素）     |

### 优化建议
- **减少重排**：

    - 批量修改样式：使用 class 或 cssText 一次性修改样式，而非逐行更改。

    - 脱离文档流：对复杂动画元素使用 position: absolute/fixed，减少布局影响范围。

    - 避免频繁读取布局属性（如 offsetTop），或在读取前先完成所有写入操作。

    - 使用 DocumentFragment 批量操作 DOM 后再插入页面。

- **减少重绘**：

    - 使用 CSS3 动画（transform、opacity）代替直接修改尺寸/位置，触发 GPU 加速。

    - 将频繁更新的元素提升为合成层（will-change: transform）。

## 扩展 - 为什么 transform 的效率高？
因为 transform 既不会影响布局也不会影响绘制指令，它影响的只是渲染流程的最后一个 `draw` 阶段。

由于 draw 阶段在合成线程中，所以 transform 的变化几乎不会影响渲染主线程。反之，渲染主线程无论如何忙碌，也不会影响 transform 的变化。

